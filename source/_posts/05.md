---
title: 第四弹
data: 2025-01-03 20:50:00
updated: 2025-01-03 20:50:00
type: ROS2
top_img:
cover: http://picbed.yanzu.tech/img/post_cover/p5.png
tags:
  - ROS2
  - Learning
---

# 使用功能包组织cpp节点

> ### 创建一个功能包，这里所在的目录是  ~/learn_ros2/chapter_2/
>
> ```shell
> ros2 pkg create demo_one_pkg --build-type ament_cmake --license Apache-2.0
> ```
>
> ### 创建好之后显示以下信息，
>
> ![](http://picbed.yanzu.tech/img/learn_ros2/pic_5.png)
>
> ### 目录结构如下，include/demo_one_pkg 文件用于存放编写的头文件/库文件
>
> ![](http://picbed.yanzu.tech/img/learn_ros2/pic_6.png)
>
> ### 创建好包之后，进入 demo_one_pkg/src/ 目录下，创建一个 .cpp 文件，这里叫 demo_one.cpp，内容如下，
>
> ```cpp
> #include "rclcpp/rclcpp.hpp"
> 
> int main(int argc, char **argv){
>     // 初始化参数
>     rclcpp::init(argc, argv);
>     // 创建节点
>     auto node = std::make_shared<rclcpp::Node>("demo_one_node");
>     // 打印日志
>     RCLCPP_INFO(node->get_logger(), "hello");
>     // 运行节点
>     rclcpp::spin(node);
>     // 关闭节点
>     rclcpp::shutdown();
>     return 0;
> }
> ```
>
> ### 返回上一级目录，即 demo_one_pkg/，编辑 CMakeLists.txt
>
> ```shell
> cmake_minimum_required(VERSION 3.8)
> project(demo_one_pkg)
> 
> if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
>   add_compile_options(-Wall -Wextra -Wpedantic)
> endif()
> 
> # 找到依赖
> find_package(ament_cmake REQUIRED)
> 
> # 1.查找 rclcpp 的头文件和库文件
> find_package(rclcpp REQUIRED)
> 
> # uncomment the following section in order to fill in
> # further dependencies manually.
> # find_package(<dependency> REQUIRED)
> 
> # 2.添加可执行文件，(节点名，源文件地址)
> add_executable(demo_one_node src/demo_one.cpp)
> 
> # 头文件包含
> # target_inlude_directories(demo_one_node PUBLIC ${rclcpp_INCLUDE_DIRS})
> # 库文件链接
> # target_link_libraries(demo_one_node ${rclcpp_LIBRARIES})
> 
> # 上面两句用这一句代替,他是依赖于 find_package(ament_cmake REQUIRED) 的
> ament_target_dependencies(demo_one_node rclcpp)
> 
> # 将 demo_one_node 拷贝到 install目录下
> install(TARGETS demo_one_node	# 这里执行后目录就已经是 install/demo_one_pkg/
> # 拷贝到 install/pkg_name/lib/pkg_name/ 下
> DESTINATION lib/${PROJECT_NAME}	# 这里执行后最后目录就是 install/demo_one_pkg/lib/demo_one_pkg/
> )
> 
> if(BUILD_TESTING)
>   find_package(ament_lint_auto REQUIRED)
>   # the following line skips the linter which checks for copyrights
>   # comment the line when a copyright and license is added to all source files
>   set(ament_cmake_copyright_FOUND TRUE)
>   # the following line skips cpplint (only works in a git repo)
>   # comment the line when this package is in a git repo and when
>   # a copyright and license is added to all source files
>   set(ament_cmake_cpplint_FOUND TRUE)
>   ament_lint_auto_find_test_dependencies()
> endif()
> 
> ament_package()
> ```
>
> ### 在与 CMakeLists.txt 同级目录下还有一个 package.xml 文件，在该文件中也要对引用的头文件进行声明
>
> ```xml
> <?xml version="1.0"?>
> <?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypens="http://www.w3.org/2001/XMLSchema"?>
> <package format="3">
>   <name>demo_one_pkg</name>
>   <version>0.0.0</version>
>   <description>TODO: Package description</description>
>   <maintainer email="yanzu@todo.todo">yanzu</maintainer>
>   <license>Apache-2.0</license>
>   
>   <!-- 在这里添加头文件的声明 -->
>   <depend>rclcpp</depend>
>   <buildtool_depend>ament_cmake</buildtool_depend>
> 
>   <test_depend>ament_lint_auto</test_depend>
>   <test_depend>ament_lint_common</test_depend>
> 
>   <export>
>     <build_type>ament_cmake</build_type>
>   </export>
> </package>
> 
> ```
>
> 
>
> ### 然后就可以对包进行编译了，编译时必须要在包的上一路径打开终端进行编译
>
> ### 在正式编译之前，可以在包目录下创建一个 build 文件先测试一下编译能否通过，创建这个build的目的是为了存放编译生成的文件
>
> ```shell
> mkdir build
> cd build/
> cmake ../
> make
> ```
>
> ### 因为 CMakeLists.txt 在上一级目录中，要使其转换为 makefile ，所以是 cmake ../
>
> ### 这里在 demo_one_pkg 的上一路径下进行编译，也即 chapter_2/ 路径下进行编译
>
> ```shell
> cd ..
> colcon build
> ```
>
> ### 编译成功后，显示如下信息
>
> ![](http://picbed.yanzu.tech/img/learn_ros2/pic_7.png)
>
> ### 此时，chapter_2/ 路径下分别有这些文件，build、install、log、demo_one_pkg
>
> ### 生成的可执行文件 demo_one_node 在 build/pkg_name/ 下，在该路径下，执行以下命令，可以查看当前节点依赖了哪些库，是否链接上
>
> ```shell
> ldd demo_one_node
> ```
>
> ### 正式运行节点之前要添加环境变量，可以使用以下命令查看当前包的环境变量是否配置了，未配置直接运行节点会显示找不到当前的包(以下命令都是在 chapter_2/ 路径下执行)
>
> ```shell
> printenv | grep AMENT
> ```
>
> ### 使用以下命令进行环境变量配置
>
> ```shell
> source install/setup.bash
> ```
>
> ### 再使用上面查看环境变量的命令看看是否配置成功，最后运行节点（ros2 run pkg_name node_name）
>
> ```shell
> ros2 run demo_one_pkg demo_one_node
> ```
>
> 
